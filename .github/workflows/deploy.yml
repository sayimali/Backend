name: Deploy Backend (Blue-Green)

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Setup SSH
      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.7.0
        with:
          ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}

      # 3️⃣ Copy code to EC2
      - name: Sync Backend code to EC2
        run: |
          ssh -o StrictHostKeyChecking=no sayim@13.126.72.177 "mkdir -p ~/apps/backend_tmp"
          rsync -avz --delete --exclude node_modules ./ sayim@13.126.72.177:~/apps/backend_tmp/

      # 4️⃣ Build GREEN container on server
      - name: Deploy GREEN container
        run: |
          ssh sayim@13.126.72.177 "
            cd ~/apps/backend_tmp &&
            docker-compose -f docker-compose.yml up -d --build backend_green &&
            echo 'GREEN built'
          "

      # 5️⃣ Health check GREEN
      - name: Health check GREEN
        run: |
          ssh sayim@13.126.72.177 "
            GREEN_HEALTH=\$(curl -s -o /dev/null -w '%{http_code}' http://localhost:3007/health);
            if [ \$GREEN_HEALTH -ne 200 ]; then
              echo 'GREEN failed health check';
              docker logs backend_green;
              exit 1;
            fi
            echo 'GREEN is healthy'
          "

      # 6️⃣ Switch Nginx to GREEN
      - name: Switch Nginx to GREEN
        run: |
          ssh sayim@13.126.72.177 "
            sudo sed -i 's/server 127.0.0.1:3006;/server 127.0.0.1:3007;/g' /etc/nginx/sites-available/backend.conf &&
            sudo nginx -t &&
            sudo systemctl reload nginx
          "

      # 7️⃣ Stop BLUE
      - name: Stop old BLUE container
        run: |
          ssh sayim@13.126.72.177 "
            docker stop backend_blue || true &&
            docker rm backend_blue || true &&
            echo 'BLUE stopped'
          "

      # 8️⃣ Rename GREEN → BLUE for next deploy
      - name: Promote GREEN to BLUE
        run: |
          ssh sayim@13.126.72.177 "
            docker rename backend_green backend_blue &&
            echo 'GREEN promoted to BLUE'
          "

      # 9️⃣ Clean temporary directory
      - name: Cleanup
        run: |
          ssh sayim@13.126.72.177 "rm -rf ~/apps/backend_tmp"
